<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserBoardMapper">

	<!-- 문의글 작성 -->
	<insert id="insertUserBoard" parameterType="UserBoardVO">
		INSERT INTO
		USERBOARD( UB_HEAD,UB_TITLE,UB_CONTENT, UB_REGDATE)
		VALUES(#{ub_head}, #{ub_title}, #{ub_content},now(), 0)
	</insert>

	<!-- 문의글 불러오기 -->
	<select id="getUserBoard" parameterType="UserBoardVO"
		resultType="UserBoardVO">
		SELECT USERBOARD.*,USER.NAME,USER.PHONE
		FROM USERBOARD INNER
		JOIN USER
		ON USERBOARD.ID = USER.ID
		WHERE UB_ID = #{ub_id};
	</select>

	<!-- 문의 목록 불러오기 -->
	<select id="getUserBoardList" parameterType="hashmap"
		resultType="UserBoardVO">
		SELECT *
		FROM USERBOARD
		WHERE ID = #{id}
		<if test="searchCondition != null and searchKeyword != null">
			AND
			<choose>
				<when test="searchCondition == 'ub_title'">
					UB_TITLE LIKE '%${searchKeyword}%'
				</when>
				<when test="searchCondition == 'ub_content'">
					UB_CONTENT LIKE '%${searchKeyword}%'
				</when>
				<when test="searchCondition == 'ub_head'">
					UB_HEAD LIKE '%${searchKeyword}%'
				</when>
			</choose>
		</if>
		<if test="startDate != null and endDate != null">
			AND DATE(UB_REGDATE) BETWEEN #{startDate} AND #{endDate}
		</if>
		ORDER BY UB_ID DESC
	</select>
	
	<!-- 마이페이지 최근신청목록  -->
	<select id="getUserRecentList" parameterType="hashmap"
		resultType="UserRentalVO">
  			SELECT BUY.*, GOODS.G_NAME, GOODS.G_RIMG2
            FROM BUY
            INNER JOIN GOODS ON BUY.G_ID = GOODS.G_ID
            WHERE BUY.B_SIGNDATE >= CURRENT_DATE - INTERVAL 30 DAY
             AND BUY.ID = #{id}
            ORDER BY BUY.B_ID DESC
            
	</select>
	
	<!-- 렌탈신청목록 불러오기 -->
	<select id="getUserRentalList" parameterType="hashmap"
		resultType="UserRentalVO">

		SELECT BUY.*,GOODS.G_NAME,GOODS.G_RIMG2, u.NAME 
		FROM BUY
		INNER JOIN GOODS
		ON
		BUY.G_ID = GOODS.G_ID
		WHERE ID = #{id}
		<if test="searchCondition != null and searchKeyword != null">
			<choose>
				<when test="searchCondition == 'g_name'">
					AND GOODS.G_NAME LIKE '%${searchKeyword}%'
				</when>
				<when test="searchCondition == 'p_name'">
					AND P_NAME LIKE '%${searchKeyword}%'
				</when>
				<when test="searchCondition == 'b_rent'">
					AND B_RENT LIKE '%${searchKeyword}%'
				</when>
					<when test="searchCondition == 'b_signdate'">
					AND B_SIGNDATE LIKE '%${searchKeyword}%'
				</when>
			</choose>
		</if>
		<if test="startDate != null and endDate != null">
			AND DATE(B_SIGNDATE) BETWEEN #{startDate} AND #{endDate}
		</if>
		ORDER BY BUY.B_ID DESC
	</select>
	
	<!-- 관리자페이지-->

	<select id="dashboardUserBoardList" resultType="UserBoardVO">
		SELECT UB_ID , UB_TITLE , id 
		FROM USERBOARD U 
		ORDER BY UB_ID DESC  LIMIT 5 ;
	</select>
	
	<update id="insertAnswer" parameterType="UserBoardVO">
		UPDATE USERBOARD 
		SET ub_answer = '${ub_answer }' 
		WHERE ub_id = #{ub_id};
	</update>
	
	<select id="admingetUserBoardList" resultType="UserBoardVO">
		SELECT *
		FROM USERBOARD 
		ORDER BY UB_ID DESC
		LIMIT #{criteria.amount} OFFSET #{criteria.startNum};
	</select>	
	
    <select id="getTotal" resultType="int">
        select count(*) from USERBOARD;
    </select>	

    <select id="rentalList" parameterType="hashmap" resultType="UserRentalVO">
		SELECT BUY.*,GOODS.G_NAME,GOODS.G_RIMG2, u.NAME ,u.phone
		FROM BUY
		INNER JOIN GOODS
		ON
		BUY.G_ID = GOODS.G_ID
		INNER JOIN `user` u
		ON
		buy.id = u.id 
		WHERE BUY.S_NAME  = #{name};
    </select>

</mapper>